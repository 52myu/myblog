<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="OBJ,OBJ阅读器"/>
    <meta name="keywords" content="javascripts,nodejs,http,nginx,react,react-native"/>
    <meta name="author" content="Xiaotao Nie,onlythen@yeah.net"/>
    <meta name="viewport" content="width=divice-width,initial-scale=1.2,user-scalable=no,maximum-scale=1">
    <title>OBJ查看器</title>
    <link rel="stylesheet" href="bootstrap.min.css">
    <link href="buttons.css" rel="stylesheet" type="text/css"/>
    <script src="jquery.min.js"></script>
    <script src="bootstrap.min.js"></script>
    <style>
        body{
            height: 736px;
            background-color: #c0c0c0;
        }
        *{
            margin:0;
            padding: 0;
        }
        #webgl{
            width: 100%;
            height: 536px;
        }
        .tools{
            width: 414px;
            height: 196px;
            display: block;
            background-color: rgb(29,29,29);
        }
        .nav-tabs>li>a{
            border-radius: 0;
        }
        .tab-content div{
            color:#cccccc;
            overflow: scroll;
        }
        .picList{
            min-width:720px;
            height: 140px;
            display: block;
            padding-top: 5px;
        }
        .picList2{
            min-width:1020px;
            height: 140px;
            display: block;
            padding-top: 5px;
        }
        .picLi{
            display: inline;
            width: 140px;
            height: 140px;
        }
        .picLi img{
            margin: 10px;
            width: 120px;
            height: 120px;
        }
        #home,#settings{
            overflow: scroll;
        }
        #profile{
            overflow: hidden;
        }
        .controlPosition{
            display: inline-block;
            margin: 12px;
            text-align: center;
            margin-top: 8px;
            min-height: 132px;
        }
        .button-group{
            margin-bottom: 5px;
        }
        .controlContain2{
            width: 770px;
        }

    </style>
</head>
<body  onload="main()">


<div>
    <canvas id="webgl" width="414" height="536">
    </canvas><div class="tools" style="margin-top: 0">
    <!-- Nav tabs -->
    <ul class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active"><a href="#home" role="tab" data-toggle="tab">SELECT</a></li>
        <li role="presentation"><a href="#messages" role="tab" data-toggle="tab">TEXTURE</a></li>
        <li role="presentation"><a href="#profile" role="tab" data-toggle="tab">SIZE</a></li>
        <li role="presentation"><a href="#settings" role="tab" data-toggle="tab">ILLUMINATION</a></li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">
        <div role="tabpanel" class="tab-pane active" id="home">
            <ul class="picList" id="picSelect">
                <li class="picLi">
                    <img class="certainPic" src="showList/p1.jpg" alt="./001.obj"/>
                </li>
                <li class="picLi">
                    <img class="certainPic" src="showList/p2.jpg" alt="./002.obj"/>
                </li>
                <li class="picLi">
                    <img class="certainPic" src="showList/p3.jpg"  alt="./052.obj"/>
                </li>
                <li class="picLi">
                    <img class="certainPic" src="showList/p4.jpg"  alt="./051.obj"/>
                </li>
                <li class="picLi">
                    <img class="certainPic" src="showList/p5.jpg"  alt="./054.obj"/>
                </li>
            </ul>
        </div>
        <div role="tabpanel" class="tab-pane" id="profile">
            <div class="controlContainer">
                <div class="controlPosition">
                    <p>观察点</p>
                    <div>
                        <div class="button-group">
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="position1">-</button>
                            <button type="button" class="button-tiny button button-pill" id="position1">0.00</button>
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="position1">+</button>
                        </div>
                    </div>
                    <div>
                        <div class="button-group">
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="position2">-</button>
                            <button type="button" class="button-tiny button button-pill" id="position2">25.00</button>
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="position2">+</button>
                        </div>
                    </div>
                    <div>
                        <div class="button-group">
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="position3">-</button>
                            <button type="button" class="button-tiny button button-pill" id="position3">0.00</button>
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="position3">+</button>
                        </div>
                    </div>
                </div>
                <div class="controlPosition">
                    <p>缩放比</p>
                    <div>
                        <div class="button-group">
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="scale">-</button>
                            <button type="button" class="button-tiny button button-pill" id="scale">1</button>
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="scale">+</button>
                        </div>
                    </div>
                    <p>透视比</p>
                    <div>
                        <div class="button-group">
                            <button type="button" class="button-tiny button button-pill button-primary">-</button>
                            <button type="button" class="button-tiny button button-pill">1</button>
                            <button type="button" class="button-tiny button button-pill button-primary">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div role="tabpanel" class="tab-pane" id="messages">
            <ul class="picList2" id="textureSelect">
                <li class="picLi">
                    <img class="certainPic" src="textTures/lastics1.jpg" />
                </li>
                <li class="picLi">
                    <img class="certainPic" src="textTures/metal1.jpg" />
                </li>
                <li class="picLi">
                    <img class="certainPic" src="textTures/metal2.jpg"/>
                </li>
                <li class="picLi">
                    <img class="certainPic" src="textTures/wood1.jpg" />
                </li>
                <li class="picLi">
                    <img class="certainPic" src="textTures/wood2.jpg"/>
                </li>
                <li class="picLi">
                    <img class="certainPic" src="textTures/texture1.jpg"/>
                </li>
                <li class="picLi">
                    <img class="certainPic" src="textTures/pure1.png"/>
                </li>
            </ul>
        </div>
        <div role="tabpanel" class="tab-pane" id="settings">
            <div class="controlContain2">
                <div class="controlPosition">
                    <button class="button button-primary  button-small" style="margin-bottom: 5px;margin-top: 40px" id="beginDot">开启点光源</button><br/>
                    <button class="button button-primary  button-small" id="beginLine">开启平行光</button>
                </div>
                <div class="controlPosition">
                    <p style="margin-top: 6px"> 点光源位置</p>
                    <div>
                        <div class="button-group">
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightP1">-</button>
                            <button type="button" class="button-tiny button button-pill" id="lightP1">0</button>
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightP1">+</button>
                        </div>
                    </div>
                    <div>
                        <div class="button-group">
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightP2">-</button>
                            <button type="button" class="button-tiny button button-pill" id="lightP2">0</button>
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightP2">+</button>
                        </div>
                    </div>
                    <div>
                        <div class="button-group">
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightP3">-</button>
                            <button type="button" class="button-tiny button button-pill" id="lightP3">-100</button>
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightP3">+</button>
                        </div>
                    </div>
                </div>
                <div class="controlPosition">
                    <p style="margin-top: 6px"> 平行光方向 </p>
                    <div>
                        <div class="button-group">
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightDir1">-</button>
                            <button type="button" class="button-tiny button button-pill" id="lightDir1">0.00</button>
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightDir1">+</button>
                        </div>
                    </div>
                    <div>
                        <div class="button-group">
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightDir2">-</button>
                            <button type="button" class="button-tiny button button-pill" id="lightDir2">-0.87</button>
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightDir2">+</button>
                        </div>
                    </div>
                    <div>
                        <div class="button-group">
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightDir3">-</button>
                            <button type="button" class="button-tiny button button-pill" id="lightDir3">-0.87</button>
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightDir3">+</button>
                        </div>
                    </div>
                </div>
                <div class="controlPosition">
                    <p style="margin-top: 6px"> 光源颜色 </p>
                    <div>
                        <div class="button-group">
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightColor1">-</button>
                            <button type="button" class="button-tiny button button-pill" id="lightColor1">0.40</button>
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightColor1">+</button>
                        </div>
                    </div>
                    <div>
                        <div class="button-group">
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightColor2">-</button>
                            <button type="button" class="button-tiny button button-pill" id="lightColor2">0.40</button>
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightColor2">+</button>
                        </div>
                    </div>
                    <div>
                        <div class="button-group">
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightColor3">-</button>
                            <button type="button" class="button-tiny button button-pill" id="lightColor3">0.50</button>
                            <button type="button" class="button-tiny button button-pill button-primary changePosition" to="lightColor3">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</div>
</body>

<script id="shader-vs" type="x-shader/x-vertex">
    attribute vec4 a_Position;
    attribute vec4 a_Color;
    attribute vec4 a_Normal;
    attribute vec3 a_TextCord;
    uniform mat4 u_MvpMatrix;
    uniform mat4 u_ModelMatrix;
    uniform mat4 u_NormalMatrix;
    uniform int lineLight;
    uniform vec3 lightP;
    uniform vec3 lightDir;
    uniform vec3 lightColor;
    varying vec4 v_Color;
    varying vec3 v_TextCord;
    void main() {
      vec4 vertexPosition = u_ModelMatrix * a_Position;
      vec3 lightDirection0 = normalize(lightP - vec3(vertexPosition));
      vec3 lightDirection = lightDir;
      vec3 lightDirection2 = vec3(1.0, -0.87, -0.87);
      vec3 lightDirection3 = vec3(-1.0, -0.87, -0.87);
      vec3 lightColor = lightColor;
      gl_Position = u_MvpMatrix * a_Position;
      vec3 normal = normalize(vec3(u_NormalMatrix * a_Normal));

      float nDotL0 = max(dot(normal, lightDirection0), 0.0);
      vec3 diffuse = lightColor * a_Color.rgb * nDotL0;
      vec3 ambient = vec3(0.02, 0.02, 0.02) * a_Color.rgb;

      float nDotL = max(dot(normal, lightDirection), 0.0);
      float nDotL2 = max(dot(normal, lightDirection2), 0.0);
      float nDotL3 = max(dot(normal, lightDirection3), 0.0);
      //v_Color = a_Color;
      v_TextCord = a_TextCord;

      if(lineLight==0)v_Color = vec4(diffuse + ambient, a_Color.a);
      else
      v_Color = vec4(a_Color.rgb * nDotL * 0.2+ lightColor * a_Color.rgb * 0.4,  a_Color.a);
    }
</script>

<script id="shader-fs" type="x-shader/x-fragment">
    #ifdef GL_ES
    precision mediump float;
    #endif
    varying vec3 v_TextCord;
    varying vec4 v_Color;
    uniform sampler2D u_Sampler;
    void main() {
        if(v_TextCord.z==1.0){
          gl_FragColor = texture2D(u_Sampler, v_TextCord.xy) * 0.5 + v_Color * 0.5;
        }else{
          gl_FragColor = v_Color;
        }
    }
</script>

<script src="./lib/webgl-utils.js"></script>
<script src="./lib/webgl-debug.js"></script>
<script src="./lib/cuon-utils.js"></script>
<script src="./lib/cuon-matrix.js"></script>
<script src="new_readObj.js"></script>

<script>


    var configs={
        target:"./051.obj",
        texture:'./textTures/pure1.png',
        toLookAt:[0.0, 25.0, 0.0],
        scale:1,
        lineLight:0,
        lightP:new Float32Array(3),
        lightDir:new Float32Array(3),
        lightColor:new Float32Array(3),
    };
    configs.lightP = [0, 0, -100];
    configs.lightDir = [0.0, -0.87, -0.87];
    configs.lightColor = [0.4, 0.4, 0.4];

    var picSelect = document.getElementById("picSelect");
    picSelect.addEventListener("click",function(e){
        if(e.target.nodeName.toUpperCase()=="IMG") {
            console.log("e.target.nodeValue", e.target.attributes["alt"].value);
            window.cancelAnimationFrame(animationID);
            configs.target= e.target.attributes["alt"].value;
            main();
        }
    });
    var textureSelect = document.getElementById("textureSelect");
    textureSelect.addEventListener("click",function(e){
        if(e.target.nodeName.toUpperCase()=="IMG") {
            console.log("texture:e.target.nodeValue", e.target.attributes["src"].value);
            window.cancelAnimationFrame(animationID);
            configs.texture= e.target.attributes["src"].value;
            main();
        }
    });
    var changePosition = document.getElementsByClassName("changePosition");
//    console.log("changePosition",changePosition);
    Array.prototype.forEach.call(changePosition,function(node){
        node.addEventListener("click",function(e){
            console.log("begin to change the observe position",e.target.attributes["to"].value.charAt(8));
            switch (e.target.attributes["to"].value){
                case "position1":
                case "position2":
                case "position3":
                    if(e.target.childNodes.item(0).nodeValue=="+"){
                        configs.toLookAt[parseInt(e.target.attributes["to"].value.charAt(8))-1]=parseFloat((parseFloat(document.getElementById(e.target.attributes["to"].value).innerHTML)+1.0).toFixed(2));
                        document.getElementById(e.target.attributes["to"].value).innerHTML=configs.toLookAt[parseInt(e.target.attributes["to"].value.charAt(8))-1].toString();
                    }
                    else{
                        configs.toLookAt[parseInt(e.target.attributes["to"].value.charAt(8))-1]=parseFloat((parseFloat(document.getElementById(e.target.attributes["to"].value).innerHTML)-1.0).toFixed(2));
                        document.getElementById(e.target.attributes["to"].value).innerHTML=configs.toLookAt[parseInt(e.target.attributes["to"].value.charAt(8))-1].toString();
                    }
                    break;

                case "scale":
                    if(e.target.childNodes.item(0).nodeValue=="+"){
                        configs.scale = (parseFloat(document.getElementById(e.target.attributes["to"].value).innerHTML)+0.1).toFixed(2);
                        document.getElementById(e.target.attributes["to"].value).innerHTML=configs.scale.toString();
                    }
                    else{
                        configs.scale = (parseFloat(document.getElementById(e.target.attributes["to"].value).innerHTML)-0.1).toFixed(2);
                        document.getElementById(e.target.attributes["to"].value).innerHTML=configs.scale.toString();
                    }
                    break;
                case "lightP1":
                case "lightP2":
                case "lightP3":
                    if(e.target.childNodes.item(0).nodeValue=="+"){
                        configs.lightP[parseInt(e.target.attributes["to"].value.charAt(6))-1]=parseFloat((parseFloat(document.getElementById(e.target.attributes["to"].value).innerHTML)+1.0).toFixed(2));
                        document.getElementById(e.target.attributes["to"].value).innerHTML=configs.lightP[parseInt(e.target.attributes["to"].value.charAt(6))-1].toString();
                    }
                    else{
                        configs.lightP[parseInt(e.target.attributes["to"].value.charAt(6))-1]=parseFloat((parseFloat(document.getElementById(e.target.attributes["to"].value).innerHTML)-1.0).toFixed(2));
                        document.getElementById(e.target.attributes["to"].value).innerHTML=configs.lightP[parseInt(e.target.attributes["to"].value.charAt(6))-1].toString();
                    }
                    break;
                case "lightDir1":
                case "lightDir2":
                case "lightDir3":
                    if(e.target.childNodes.item(0).nodeValue=="+"){
                        configs.lightDir[parseInt(e.target.attributes["to"].value.charAt(8))-1]=parseFloat((parseFloat(document.getElementById(e.target.attributes["to"].value).innerHTML)+0.1).toFixed(2));
                        document.getElementById(e.target.attributes["to"].value).innerHTML=configs.lightDir[parseInt(e.target.attributes["to"].value.charAt(8))-1].toString();
                    }
                    else{
                        configs.lightDir[parseInt(e.target.attributes["to"].value.charAt(8))-1]=parseFloat((parseFloat(document.getElementById(e.target.attributes["to"].value).innerHTML)-0.1).toFixed(2));
                        document.getElementById(e.target.attributes["to"].value).innerHTML=configs.lightDir[parseInt(e.target.attributes["to"].value.charAt(8))-1].toString();
                    }
                    break;
                case "lightColor3":
                case "lightColor2":
                case "lightColor1":
                    if(e.target.childNodes.item(0).nodeValue=="+"){
                        configs.lightColor[parseInt(e.target.attributes["to"].value.charAt(10))-1]=parseFloat((parseFloat(document.getElementById(e.target.attributes["to"].value).innerHTML)+0.02).toFixed(2));
                        document.getElementById(e.target.attributes["to"].value).innerHTML=configs.lightColor[parseInt(e.target.attributes["to"].value.charAt(10))-1].toString();
                    }
                    else{
                        configs.lightColor[parseInt(e.target.attributes["to"].value.charAt(10))-1]=parseFloat((parseFloat(document.getElementById(e.target.attributes["to"].value).innerHTML)-0.02).toFixed(2));
                        document.getElementById(e.target.attributes["to"].value).innerHTML=configs.lightColor[parseInt(e.target.attributes["to"].value.charAt(10))-1].toString();
                    }
                    break;
            }
            console.log(configs.lightDir,"configs");
            window.cancelAnimationFrame(animationID);
            main(true);
        });
    });
    var beginDot = document.getElementById("beginDot");
    var beginLine = document.getElementById("beginLine");
    beginDot.addEventListener("click",function(e){
        if(configs.lineLight==1){
            configs.lineLight=0;
            window.cancelAnimationFrame(animationID);
            main();
        }
    });
    beginLine.addEventListener("click",function(e){
        if(configs.lineLight==0){
            configs.lineLight=1;
            window.cancelAnimationFrame(animationID);
            main();
        }
    });





    //用一个配置对象，对所有内容进行配置


    const MAX = 65532;

    var animationID;
    var modelObject = [];
    var mtlArray = [];
    var objArray = [];
    var TextureArray = [];
    var loadTextures = {unload:0};//加载纹理状态锁,0表示没有待加载的纹理，可以绘制了
    var g_modelMatrix = new Matrix4();
    var g_mvpMatrix = new Matrix4();
    var g_normalMatrix = new Matrix4();

    var jjjj = 0;
    //需要绑定this 这里面的this就是对于每一个模型来说总的内容的实例
    //这个函数实际上并没有优化的很好,现在只是相当于列出,但是这种方式比较方便
    function getDrawingInfo(ifTexture) {
        // Create an arrays for vertex coordinates, normals, colors, and indices
        var numIndices = 0;
        for(var i = 0; i < this.objects.length; i++){
            numIndices += this.objects[i].numIndices;
            //每一个objects[i].numIndices 是它的所有的face的顶点数加起来
        }
        var numVertices = numIndices;
        var vertices = new Float32Array(numVertices * 3);
        var normals = new Float32Array(numVertices * 3);
        var colors = new Float32Array(numVertices * 4);
        //这个地方的16是不能转化成32的
        var indices = new Uint16Array(numIndices);

        //尝试增加贴图
        var textureVt = new Float32Array(numVertices * 3);

        // Set vertex, normal, texture and color
        //一个face一个face的遍历
        var index_indices = 0;
        for(i = 0; i < this.objects.length; i++){
            var object = this.objects[i];
            if(jjjj<1)console.log("object.faces.length",object.faces.length,this.objects.length);
            for(var j = 0; j < object.faces.length; j++){
                var face = object.faces[j];
                var color = findColor(this,face.materialName);
                // console.log(face.materialName,color);
                var faceNormal = face.normal;
                for(var k = 0; k < face.vIndices.length; k++){
                    // Set index
                    indices[index_indices] = index_indices%MAX;
                    // Copy vertex
                    var vIdx = face.vIndices[k];
                    var vertex = this.vertices[vIdx];
                    vertices[index_indices * 3    ] = vertex.x;
                    vertices[index_indices * 3 + 1] = vertex.y;
                    vertices[index_indices * 3 + 2] = vertex.z;

                    var tIdx = face.tIndices[k];
                    var Tvertex = this.textureVt[tIdx];
                    if(!!Tvertex) {
                        textureVt[index_indices * 3] = Tvertex.x;
                        textureVt[index_indices * 3 + 1] = Tvertex.y;
                        textureVt[index_indices * 3 + 2] = ifTexture;
                    }
                    else{
                        //有些是没有纹理坐标的,这个时候把纹理坐标置成系统默认值
                        textureVt[index_indices * 3] = 0;
                        textureVt[index_indices * 3 + 1] = 0;
                        textureVt[index_indices * 3 + 2] = ifTexture;
                    }

                    // Copy color
                    colors[index_indices * 4    ] = color.r;
                    colors[index_indices * 4 + 1] = color.g;
                    colors[index_indices * 4 + 2] = color.b;
                    colors[index_indices * 4 + 3] = color.a;
                    // console.log(colors,color);
                    // Copy normal
                    var nIdx = face.nIndices[k];
                    if(nIdx >= 0){
                        var normal = this.normals[nIdx];
                        normals[index_indices * 3    ] = normal.x;
                        normals[index_indices * 3 + 1] = normal.y;
                        normals[index_indices * 3 + 2] = normal.z;
                    }else{
                        normals[index_indices * 3    ] = faceNormal.x;
                        normals[index_indices * 3 + 1] = faceNormal.y;
                        normals[index_indices * 3 + 2] = faceNormal.z;
                    }
                    index_indices ++;
                }
                jjjj++;
            }
        }
        return new DrawingInfo(vertices, normals, colors, indices, textureVt);
    }

    var ready = true;

    //最多绘制65535个点，这里面的其他内容，都是和indices有倍数关系的，要改变indices的同时也要改变其他的
    function onReadComplete(gl, model, target,begin,numbers,ifTexture) {
        // Acquire the vertex coordinates and colors from OBJ file
        //console.log("target",target);
        var drawingInfo = getDrawingInfo.call(target,ifTexture);
        if(ready) {
            console.log(drawingInfo, "drawingInfo");
            ready = !ready;
        }
        // Write date into the buffer object
        gl.bindBuffer(gl.ARRAY_BUFFER, model.vertexBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, drawingInfo.vertices.slice(begin*3,(begin+numbers)*3), gl.STATIC_DRAW);

        gl.bindBuffer(gl.ARRAY_BUFFER, model.normalBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, drawingInfo.normals.slice(begin*3,(begin+numbers)*3), gl.STATIC_DRAW);

        gl.bindBuffer(gl.ARRAY_BUFFER, model.colorBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, drawingInfo.colors.slice(begin*4,(begin+numbers)*4), gl.STATIC_DRAW);

        gl.bindBuffer(gl.ARRAY_BUFFER, model.textBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, drawingInfo.textureVt.slice(begin*3,(begin+numbers)*3), gl.STATIC_DRAW);

        // Write the indices to the buffer object
        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, model.indexBuffer);
        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, drawingInfo.indices.slice(begin,begin+numbers), gl.STATIC_DRAW);

        return drawingInfo;
    }

    function ShaderSourceFromScript(scriptID)
    {
        var shaderScript = document.getElementById(scriptID);
        if (shaderScript == null) return "";

        var sourceCode = "";
        var child = shaderScript.firstChild;
        while (child)
        {
            if (child.nodeType == child.TEXT_NODE ) sourceCode += child.textContent;
            child = child.nextSibling;
        }

        return sourceCode;
    }


    var VSHADER_SOURCE = ShaderSourceFromScript("shader-vs");

    // Fragment shader program
    var FSHADER_SOURCE = ShaderSourceFromScript("shader-fs");


    function main(NotReload) {

        // Retrieve <canvas> element
        var canvas = document.getElementById('webgl');

        // Get the rendering context for WebGL
        var gl = getWebGLContext(canvas);
        if (!gl) {
            console.log('Failed to get the rendering context for WebGL');
            return;
        }

        // Initialize shaders
        if (!initShaders(gl, VSHADER_SOURCE, FSHADER_SOURCE)) {
            console.log('Failed to intialize shaders.');
            return;
        }

        // Set the clear color and enable the depth test
        gl.clearColor(0.75, 0.75, 0.75, 1.0);
        gl.enable(gl.DEPTH_TEST);

        // Get the storage locations of attribute and uniform variables
        var program = gl.program;
        program.a_Position = gl.getAttribLocation(program, 'a_Position');
        program.a_Normal = gl.getAttribLocation(program, 'a_Normal');
        program.a_Color = gl.getAttribLocation(program, 'a_Color');
        program.a_TextCord = gl.getAttribLocation(program, 'a_TextCord');
        program.u_MvpMatrix = gl.getUniformLocation(program, 'u_MvpMatrix');
        program.u_NormalMatrix = gl.getUniformLocation(program, 'u_NormalMatrix');
        program.u_ModelMatrix = gl.getUniformLocation(program, 'u_ModelMatrix');
        program.u_lineLight = gl.getUniformLocation(program, 'lineLight');
        program.u_lightP = gl.getUniformLocation(program, 'lightP');
        program.u_lightDir = gl.getUniformLocation(program, 'lightDir');
        program.u_lightColor = gl.getUniformLocation(program, 'lightColor');

        if (program.a_Position < 0 ||  program.a_Normal < 0 || program.a_Color < 0 || program.a_TextCord <0 ||
                !program.u_MvpMatrix || !program.u_NormalMatrix) {
            console.log('attribute, uniform失敗');
            return;
        }

        // Prepare empty buffer objects for vertex coordinates, colors, and normals
        var model = initVertexBuffers(gl, program);
        if (!model) {
            console.log('Failed to set the vertex information');
            return;
        }

        // 投影行列計算
        var viewProjMatrix = new Matrix4();
        viewProjMatrix.setPerspective(30.0, canvas.width/canvas.height, 1.0, 5000.0);
        viewProjMatrix.lookAt(0.0, 100.0, 100.0,configs.toLookAt[0], configs.toLookAt[1],configs.toLookAt[2], 0.0, 1.0, 0.0);

        // Start reading the OBJ file
        //readOBJFile('../resources/ChairSwing.obj', modelObject,  mtlArray, objArray, 100, false, 0);
       if(NotReload){}
       else{ 
            readOBJFile(configs.target, modelObject,  mtlArray, objArray, 0.75*configs.scale, false, 0);
            TextureArray[0]={ifTexture:1.0,TextureUrl:configs.texture,n:0};
       }
//        readOBJFile('./002.obj', modelObject,  mtlArray, objArray, 10, false, 1);
//        TextureArray[1]={ifTexture:0.0,TextureUrl:'./texture1.jpg',n:0};
        //1.0代表加载纹理，0.0代表不加载纹理

        var currentAngle = [0.0, 0.0]; // Current rotation angle ([x-axis, y-axis] degrees)
        initEventHandlers(canvas, currentAngle);

//        setInterval(function(){
//            draw(gl, gl.program, currentAngle, viewProjMatrix, model);
//        },40);
        var tick = function() {   // Start drawing
            // currentAngle = animate(currentAngle); // Update current rotation angle
            if(loadTextures.unload<=0){
                initDraw(gl);
                for(var ii=0;ii<modelObject.length;ii++){
                    draw(gl, gl.program, currentAngle, viewProjMatrix, model,ii,TextureArray);
                }
            }
            animationID = requestAnimationFrame(tick, canvas);
        };


        for(var ii=0;ii<TextureArray.length;ii++){
            if(TextureArray[ii].ifTexture==1.0){
                loadTextures.unload++;
                initTextures(gl,TextureArray[ii]);
            }
        }
        initDraw(gl);
        tick();

    };

    function initEventHandlers(canvas, currentAngle) {
        var dragging = false;         // Dragging or not
        var lastX = -1, lastY = -1;   // Last position of the mouse

        canvas.onmousedown = function(ev) {   // Mouse is pressed
            var x = ev.clientX, y = ev.clientY;
            // Start dragging if a moue is in <canvas>
            var rect = ev.target.getBoundingClientRect();
            if (rect.left <= x && x < rect.right && rect.top <= y && y < rect.bottom) {
                lastX = x; lastY = y;
                dragging = true;
            }
        };

        canvas.onmouseup = function(ev) { dragging = false;  }; // Mouse is released

        canvas.onmousemove = function(ev) { // Mouse is moved
            var x = ev.clientX, y = ev.clientY;
            if (dragging) {
                var factor = 100/canvas.height; // The rotation ratio
                var dx = factor * (x - lastX);
                var dy = factor * (y - lastY);
                // Limit x-axis rotation angle to -90 to 90 degrees
                currentAngle[0] = Math.max(Math.min(currentAngle[0] + dy, 90.0), -90.0);
                currentAngle[1] = currentAngle[1] + dx;
            }
            lastX = x, lastY = y;
        };

        canvas.addEventListener("touchstart",function(e){
            e.preventDefault();

            ev = e.changedTouches ? e.changedTouches[0] : e;
            console.log("start,ev.pageX",ev.pageX,ev.pageY);

            var x = ev.pageX, y = ev.pageY;
            // Start dragging if a moue is in <canvas>
            var rect = ev.target.getBoundingClientRect();
            if (rect.left <= x && x < rect.right && rect.top <= y && y < rect.bottom) {
                lastX = x; lastY = y;
                dragging = true;
            }
        });

        canvas.addEventListener("touchmove",function(e){
            e.preventDefault();
            ev = e.changedTouches ? e.changedTouches[0] : e;

            var x = ev.pageX, y = ev.pageY;
            if (dragging) {
                var factor = 100/canvas.height; // The rotation ratio
                var dx = factor * (x - lastX);
                var dy = factor * (y - lastY);
                // Limit x-axis rotation angle to -90 to 90 degrees
                currentAngle[0] = Math.max(Math.min(currentAngle[0] + dy, 90.0), -90.0);
                currentAngle[1] = currentAngle[1] + dx;
            }
            lastX = x, lastY = y;
        });

        canvas.addEventListener("touchend",function(e){
            e.preventDefault();

            ev = e.changedTouches ? e.changedTouches[0] : e;

            dragging = false;
        });

    }



    // Create an buffer object and perform an initial configuration
    function initVertexBuffers(gl, program) {
        var o = new Object(); // Utilize Object object to return multiple buffer objects
        o.vertexBuffer = createEmptyArrayBuffer(gl, program.a_Position, 3, gl.FLOAT);
        o.normalBuffer = createEmptyArrayBuffer(gl, program.a_Normal, 3, gl.FLOAT);
        o.colorBuffer = createEmptyArrayBuffer(gl, program.a_Color, 4, gl.FLOAT);
        o.textBuffer = createEmptyArrayBuffer(gl, program.a_TextCord, 3, gl.FLOAT);
        o.indexBuffer = gl.createBuffer();
        if (!o.vertexBuffer || !o.normalBuffer || !o.textBuffer || !o.colorBuffer || !o.indexBuffer) { return null; }

        gl.bindBuffer(gl.ARRAY_BUFFER, null);

        return o;
    }

    // Create a buffer object, assign it to attribute variables, and enable the assignment
    function createEmptyArrayBuffer(gl, a_attribute, num, type) {
        var buffer =  gl.createBuffer();  // Create a buffer object
        if (!buffer) {
            console.log('Failed to create the buffer object');
            return null;
        }
        gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
        gl.vertexAttribPointer(a_attribute, num, type, true, 0, 0);  // Assign the buffer object to the attribute variable
        gl.enableVertexAttribArray(a_attribute);  // Enable the assignment

        return buffer;
    }

    //这里面的n应该是标号，只不过暂时没有用到
    function initTextures(gl,thisTexture) {
        console.log(gl,"image to onload ..",gl);
        var texture = gl.createTexture();   // Create a texture object
        if (!texture) {
            console.log('Failed to create the texture object');
            return false;
        }

        // Get the storage location of u_Sampler
        var u_Sampler = gl.getUniformLocation(gl.program, 'u_Sampler');
        console.log("u_Sampler",u_Sampler);
//        if (!u_Sampler) {
//            console.log('Failed to get the storage location of u_Sampler');
//            return false;
//        }
        var image = new Image();  // Create the image object
        if (!image) {
            console.log('Failed to create the image object');
            return false;
        }
        // Register the event handler to be called on loading an image
        image.onload = function(){
            console.log("image onload");
            loadTexture(gl, thisTexture.n, texture, u_Sampler, image);};
        // Tell the browser to load an image
//        image.src = './texture1.jpg';
        image.src = thisTexture.TextureUrl;

        return true;
    }

    function loadTexture(gl, n, texture, u_Sampler, image) {
        var TextureList = [gl.TEXTURE0,gl.TEXTURE1,gl.TEXTURE2,gl.TEXTURE3,gl.TEXTURE4,gl.TEXTURE5,gl.TEXTURE6,gl.TEXTURE7];

        gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, 1); // Flip the image's y axis
        // Enable texture unit0
        gl.activeTexture(TextureList[n]);
        // Bind the texture object to the target
        gl.bindTexture(gl.TEXTURE_2D, texture);

        // Set the texture parameters
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        // Set the texture image
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGB, gl.RGB, gl.UNSIGNED_BYTE, image);

        loadTextures.unload-=1;
        // Set the texture unit 0 to the sampler
//        gl.uniform1i(u_Sampler, n);

    }


    var tttt = 0;

    function initDraw(gl){
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);  // Clear color and depth buffers
        gl.uniform1i(gl.program.u_lineLight,configs.lineLight);
        gl.uniform3f(gl.program.u_lightP,configs.lightP[0],configs.lightP[1],configs.lightP[2]);
        gl.uniform3f(gl.program.u_lightDir,configs.lightDir[0],configs.lightDir[1],configs.lightDir[2]);
        gl.uniform3f(gl.program.u_lightColor,configs.lightColor[0],configs.lightColor[1],configs.lightColor[2]);
    }

    // 描画関数
    function draw(gl, program, angle, viewProjMatrix, model, index, TextureArray) {

//        if(mtlArray.length != 1 || objArray.length != 1 || mtlArray.some(function(x){return !x;}) || objArray.some(function(x){return !x;}  )){
//            //这里代表的是对于所有模型而言，有模型没有被渲染好，那么就不能执行绘制操作
//            //console.log("nodraw",mtlArray,objArray,(mtlArray.some(function(x){return !x;}) || objArray.some(function(x){return !x;} || mtlArray.length == 0 || objArray.length == 0)));
//            return;
//        }

        if(!mtlArray[index] || !objArray[index]){
            console.log("no object!!!");
            return;
        }

        if(TextureArray[index].ifTexture==1.0){
            var u_Sampler = gl.getUniformLocation(gl.program, 'u_Sampler');
            gl.uniform1i(u_Sampler, TextureArray[index].n);
        }

        var numIndices = 0;
        for(var i = 0; i < modelObject[index].objects.length; i++){
            numIndices += modelObject[index].objects[i].numIndices;
            //每一个objects[i].numIndices 是它的所有的face的顶点数加起来
        }

        for(var ii=0;ii<Math.ceil(numIndices/MAX);ii++){
            if(tttt<1)console.log("when tttt < 1",numIndices,(numIndices-ii*MAX)<MAX?(numIndices-ii*MAX):MAX);
            g_drawingInfo = onReadComplete(gl, model, modelObject[index],ii*MAX,(numIndices-ii*MAX)<MAX?(numIndices-ii*MAX):MAX,TextureArray[index].ifTexture);
            g_objDoc = null;
            g_modelMatrix.setRotate(angle[0], 1.0, 0.0, 0.0); // 设置模型旋转矩阵
            g_modelMatrix.rotate(angle[1], 0.0, 1.0, 0.0);
            g_mvpMatrix.set(viewProjMatrix);

            // Calculate the normal transformation matrix and pass it to u_NormalMatrix
            g_normalMatrix.setInverseOf(g_modelMatrix);
            g_normalMatrix.transpose();
            gl.uniformMatrix4fv(program.u_NormalMatrix, false, g_normalMatrix.elements);
            gl.uniformMatrix4fv(program.u_ModelMatrix, false, g_modelMatrix.elements);

            // Calculate the model view project matrix and pass it to u_MvpMatrix
            // g_mvpMatrix.multiply(g_modelMatrix);
            //g_mvpMatrix.setOrtho(-100,100,-100,100,-50,50);
            g_mvpMatrix.multiply(g_modelMatrix);
//            g_mvpMatrix.rotate(angle[0], 1.0, 0.0, 0.0);
//            g_mvpMatrix.rotate(angle[1], 0.0, 1.0, 0.0);
            //g_mvpMatrix.translate(-200.0,0.0,0.0);
            gl.uniformMatrix4fv(program.u_MvpMatrix, false, g_mvpMatrix.elements);

            // Draw
            gl.drawElements(gl.TRIANGLES,(numIndices-ii*MAX)<MAX?(numIndices-ii*MAX):MAX, gl.UNSIGNED_SHORT, 0);
        }


        tttt++;

        //-----------------------------------------------------------------------------------------------

//        g_drawingInfo = onReadComplete(gl, model, modelObject[1]);
//        g_objDoc = null;
//
//        //gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);  // Clear color and depth buffers
//
//        g_modelMatrix.setRotate(angle[0], 1.0, 0.0, 0.0); // 设置模型旋转矩阵
//        g_modelMatrix.rotate(angle[0], 0.0, 1.0, 0.0);
//        g_modelMatrix.rotate(angle[1], 0.0, 0.0, 1.0);
//        g_mvpMatrix.set(viewProjMatrix);
//
//        // Calculate the normal transformation matrix and pass it to u_NormalMatrix
//        g_normalMatrix.setInverseOf(g_modelMatrix);
//        g_normalMatrix.transpose();
//        gl.uniformMatrix4fv(program.u_NormalMatrix, false, g_normalMatrix.elements);
//
//        // Calculate the model view project matrix and pass it to u_MvpMatrix
//        // g_mvpMatrix.multiply(g_modelMatrix);
//        g_mvpMatrix.rotate(angle[1], 0.0, 1.0, 0.0);
//        g_mvpMatrix.rotate(angle[0], 1.0, 0.0, 0.0);
//        gl.uniformMatrix4fv(program.u_MvpMatrix, false, g_mvpMatrix.elements);
//
//        // Draw
//        gl.drawElements(gl.TRIANGLES, g_drawingInfo.indices.length, gl.UNSIGNED_SHORT, 0);

    }

</script>

</html>